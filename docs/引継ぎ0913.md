# 引継ぎ0913 - 明日行うこと・ゴールまでの残りタスク

## 📅 現在の進捗状況

### ✅ 完了済み（2025年9月13日）
- **Week1**: Next.js 15 + Tailwind CSS + shadcn/ui + NextAuth.js フロントエンド完成
- **Week2**: FastAPI + SQLAlchemy + JWT認証 バックエンド完成
- **422エラー問題**: フロントエンド・バックエンド連携問題を解決
- **UI/UX改善**: ダッシュボードの見た目を「会社AWS public」レベルに向上
- **AWS Amplify デプロイ**: Next.js 15アプリケーションの本番デプロイ成功

### 🎯 現在の状態
- **フロントエンド**: AWS Amplify で本番稼働中 ✅
- **バックエンド**: ローカル開発環境のみ（未デプロイ）
- **認証**: NextAuth.js + JWT で動作確認済み
- **RAG機能**: 未実装（Day9-10で予定）

---

## 🚀 明日（Day12）の作業内容

### 目標
**ECR×2リポジトリ + CodeBuild設定（ui/api）**

### 具体的なタスク

#### 1. ECRリポジトリの作成
```bash
# UI用リポジトリ
aws ecr create-repository --repository-name vendor0913-ui --region ap-northeast-1

# API用リポジトリ  
aws ecr create-repository --repository-name vendor0913-api --region ap-northeast-1
```

#### 2. Dockerfileの作成
**`backend/Dockerfile`**:
```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**`frontend/Dockerfile`**:
```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/.next /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 3. CodeBuildプロジェクトの設定
**`buildspec-ui.yml`**:
```yaml
version: 0.2
phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG .
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker image...
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
artifacts:
  files:
    - '**/*'
```

**`buildspec-api.yml`**:
```yaml
version: 0.2
phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG .
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker image...
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
artifacts:
  files:
    - '**/*'
```

#### 4. 環境変数の設定
**CodeBuild環境変数**:
- `AWS_ACCOUNT_ID`: アカウントID
- `AWS_DEFAULT_REGION`: ap-northeast-1
- `IMAGE_REPO_NAME`: vendor0913-ui / vendor0913-api
- `IMAGE_TAG`: latest

---

## 📋 残りのタスク（Day13-20）

### Day13: ECS Fargate でAPIサービス常駐化
- ECSクラスター作成
- タスク定義作成（FastAPI用）
- サービス作成・起動
- CloudWatch Logs設定

### Day14: ALB+HTTPS で公開口整備
- Application Load Balancer作成
- ACM証明書設定
- ターゲットグループ設定
- セキュリティグループ設定

### Day15: RDS PostgreSQL + pgvector移行
- RDS PostgreSQLインスタンス作成
- pgvector拡張インストール
- データベース移行
- 接続設定更新

### Day16: S3 ingest API
- S3バケット作成
- ファイルアップロード機能
- 文書分割・埋め込み処理
- pgvector保存機能

### Day17: Secrets管理・設定外出し
- AWS Secrets Manager設定
- 環境変数の外出し
- セキュリティ強化

### Day18: レート制限・監視
- WAF設定
- CloudWatch監視設定
- アラーム設定

### Day19: CI/CD & Blue/Green
- CodePipeline設定
- 自動デプロイ設定
- Blue/Greenデプロイ

### Day20: ドメイン・HTTPS & Runbook
- Route53設定
- 独自ドメイン設定
- 運用マニュアル作成

---

## 🔧 技術スタック

### フロントエンド
- **Next.js 15** (App Router)
- **Tailwind CSS v4**
- **shadcn/ui**
- **NextAuth.js**
- **AWS Amplify Hosting**

### バックエンド
- **FastAPI**
- **SQLAlchemy**
- **PostgreSQL + pgvector**
- **JWT認証**
- **AWS ECS Fargate**

### インフラ
- **AWS ECR** (コンテナレジストリ)
- **AWS ECS** (コンテナオーケストレーション)
- **AWS ALB** (ロードバランサー)
- **AWS RDS** (データベース)
- **AWS S3** (ファイルストレージ)
- **AWS Secrets Manager** (シークレット管理)

---

## 📁 プロジェクト構成

```
vendor0913/
├── frontend/                 # Next.js アプリケーション
│   ├── app/
│   ├── components/
│   ├── package.json
│   └── Dockerfile
├── backend/                  # FastAPI アプリケーション
│   ├── main.py
│   ├── models.py
│   ├── database.py
│   ├── requirements.txt
│   └── Dockerfile
├── docs/                     # ドキュメント
│   ├── 引継ぎ0913.md
│   ├── problems-solutions.md
│   └── 全体スケジュール0912.md
├── amplify.yml              # Amplify設定
└── README.md
```

---

## 🚨 注意事項

### 1. 環境変数の管理
- 本番環境では必ずAWS Secrets Managerを使用
- ローカル開発用の`.env`ファイルは`.gitignore`に追加済み

### 2. セキュリティ
- ALB経由でのみAPIにアクセス可能
- 直接ECSタスクへのアクセスは不可
- WAFでレート制限・不正アクセス防止

### 3. コスト管理
- Fargateは使用時間課金
- RDSはインスタンス課金
- 不要なリソースは定期的に確認

---

## 📞 緊急時の連絡先

- **プロジェクト責任者**: Takuya Suehiro
- **技術サポート**: AWS Support
- **ドキュメント**: `docs/`フォルダ内

---

**作成日**: 2025年9月13日  
**更新日**: 2025年9月13日  
**次回更新予定**: Day12完了後

