0912行ったこと


今日やったこと（時系列ダイジェスト）

Git整備：vendor2 リポジトリ直下に Dockerfile / app.py / requirements.txt を追加（最小の Streamlit）。

CodeBuild 修正：buildspec.yaml を正してビルド実行。

途中で Docker Hub 429 に当たり、ベースイメージを ECR Public (public.ecr.aws/docker/library/python:3.12-slim) に切替 → 成功。

ECR：vendor2-ui:latest を ap-northeast-1 に push 済み。

IAM：サービスリンクロール AWSServiceRoleForECS を作成／確認。実行ロール ecsTaskExecutionRole 利用。

ECS(Fargate)：

クラスター vendor2-cluster 作成。

タスク定義 vendor2:1（コンテナ vendor2-ui / 8080 / awslogs）。

サービス（ALBなし）を起動、パブリックIP付与で外部公開。

VPC/ネットワーク：SG を作成 → Inbound 8080 を許可。CloudShellで ENI/SG/疎通を診断して HTTP 200 を確認。

表示確認：ブラウザで Streamlit UI の表示まで完了。

セキュリティ調整：SG を あなたのIP(/32) のみに絞る方針を決定。

触ったAWSサービスと役割

CodeBuild：Docker ビルド＆ ECR へ push（特権モード ON）。

ECR：コンテナイメージ保管（vendor2-ui:latest）。

ECS(Fargate)：コンテナ実行基盤（EC2 なし運用）。

IAM：ecsTaskExecutionRole（ECR pull/CloudWatch ログ）、AWSServiceRoleForECS（SLR）。

VPC：サブネット/ENI/ルート＋セキュリティグループ設計。

CloudWatch Logs：アプリ＆タスクのログ収集（/ecs/vendor2/ui）。

CloudShell：トラブルシュート（ENI/SG/NACL/疎通/ログ tail）。

現在の構成（シンプル図）
[あなたのPC] --HTTP:8080--> [Public IP: タスクENI]
                                 │
                          (ECS Fargate Service)
                                 │
                          コンテナ: vendor2-ui
                          Streamlit :8080
                                 │
                     Logs -> CloudWatch Logs (/ecs/vendor2/ui)
                                 │
                          画像 -> ECR (vendor2-ui:latest)

主要リソースの実体

ECR：vendor2-ui（タグ latest）

CodeBuild：vendor2-ui-build（GitHub main → docker build/push）

ECS クラスタ：vendor2-cluster

タスク定義：vendor2:1（コンテナ vendor2-ui、ポート 8080、awslogs）

サービス：vendor2-service-za51r4m4（Desired=1、Public IP 付与）

ENI：eni-048eae81bf1978ee1（例）

Public IP：13.112.60.162（現行タスク）

サブネット：subnet-0cc1cc4b5e60f3fb1（Public）

SG：sg-072470b8322e9e888（Inbound: TCP 8080 → あなたのIP/32 のみに）

Logs：/ecs/vendor2/ui（prefix: app）

IAM：ecsTaskExecutionRole（AmazonECSTaskExecutionRolePolicy 付）、AWSServiceRoleForECS

運用の基本オペ（コマンド最小セット）

最新イメージへロール（ECR に push 後、ECS を切替）

aws ecs update-service \
  --cluster vendor2-cluster \
  --service vendor2-service-za51r4m4 \
  --force-new-deployment \
  --region ap-northeast-1


停止/再開（コスト抑制）

# 停止
aws ecs update-service --cluster vendor2-cluster \
  --service vendor2-service-za51r4m4 --desired-count 0 \
  --region ap-northeast-1
# 再開
aws ecs update-service --cluster vendor2-cluster \
  --service vendor2-service-za51r4m4 --desired-count 1 \
  --region ap-northeast-1


ログ確認

コンソール：ECS → タスク → コンテナ → ログ

もしくは CloudShell：aws logs tail "/ecs/vendor2/ui" --since 10m --follow

今日時点のリスク/宿題（最小）

HTTPのみ（平文）：本番前には ALB + ACM(HTTPS) 化を推奨。

IP制限：当面は あなたのIPに限定（必要な人は /32 追加）。

タグ：Project=tak-vendor2-0912, Owner=takuya_suehiro を主要リソースに付与（後からでもOK）。

オートスケール：PoC中は手動で十分。負荷が見えたら設定（CPU/メモリ or ALB RequestCount）。

CI/CD：今は手動トリガ。将来、CodePipeline or GitHub Actions で main → 自動デプロイへ。

次の展開（短期ロードマップ再掲・要点だけ）

UIとエージェント(API)を分離（FastAPI 推奨）→ ECR 2イメージ / ECS 2サービス。
内部通信は Service Connect か internal ALB。

ALB + HTTPS + WAF（本番向けの公開口）。

CI/CD（main push→Build→ECS update）と Blue/Green。

Secrets 管理（Secrets Manager/SSM）＋ 監視/アラーム（CPU/メモリ/5xx）。

（必要なら）SQSワーカーで長処理非同期化、ベクトルDB連携、SageMaker/ECS(EC2 GPU) で推論強化。





IPアドレス公開のリスクについて
気持ちはわかるんだけど、今の構成（Fargate タスクにパブリック IP＋SG で 0.0.0.0/0 の 8080 を開放）は、たとえ「悪用される要素が無さそう」に見えても、実務的にはそれなりにリスクがあります。ざっくりだけ警鐘だけ鳴らしておきますね 🙇‍♂️

なにが起こりうるか

ボットの自動スキャンは常に走っています（世界中から 8080/HTTP へ）。
既知のフレームワーク脆弱性・ディレクトリトラバーサル等を片っ端から叩いてきます。

平文 HTTP なので、社外ネット経由だと盗聴・改ざん（MITM）のリスクがあります。

アプリに脆弱性が無くても、巨大リクエスト連打や DoS でリソースを食い潰されることがあります。

将来、依存パッケージの脆弱性が見つかった時に、外部公開だと影響面が大きくなります。

「悪いことしようがない」に見えても、“開いている以上は叩かれる” がクラウドの現実です 🙏

いまのままを維持しつつ、最小限のガードだけ付ける提案（5分で終わります）
① セキュリティグループを自分のグローバル IP だけに制限

いま適用中の SG は sg-072470b8322e9e888 でした。
許可 → 自分の IP のみ／戻す → 0.0.0.0/0 をワンライナーで切り替えできます。

自分の IP のみに制限

REGION=ap-northeast-1
SG=sg-072470b8322e9e888
MYIP=$(curl -s https://checkip.amazonaws.com)/32

aws ec2 revoke-security-group-ingress \
  --group-id "$SG" --region "$REGION" \
  --protocol tcp --port 8080 --cidr 0.0.0.0/0 2>/dev/null || true

aws ec2 authorize-security-group-ingress \
  --group-id "$SG" --region "$REGION" \
  --protocol tcp --port 8080 --cidr "$MYIP"


全世界開放に戻す（必要時だけ）

aws ec2 authorize-security-group-ingress \
  --group-id "$SG" --region "$REGION" \
  --protocol tcp --port 8080 --cidr 0.0.0.0/0


共有が必要になったら、その時だけ一時的に 0.0.0.0/0 に戻す運用でも OK です。

② せめて監視だけは（CPU/Network 異常検知）

CloudWatch アラームで、CPU 使用率や NetworkIn/Out が異常に伸びたら通知。

ログは CloudWatch Logs /ecs/vendor2 を定期確認。

余裕ができたら（推奨の次の一歩）

ALB + HTTPS（ACM）：ALB に 80/443 を公開、タスク側は ALB からだけ 8080 を許可。
→ 平文化・直叩きの両方を解消できます（コストは ALB の基本料金のみ）。

定期ビルド：EventBridge で CodeBuild を週1キック → 依存の脆弱性パッチを自動で取り込み。

WAF（ALB 使う場合）：スキャン系のブロックに効きます。

まとめ：
すぐに大改修する必要はありませんが、SG を自分の IP に絞るだけでもリスクはぐっと下がります。
そのうえで、時間ができたら ALB + HTTPS に寄せる、の順で十分です。

